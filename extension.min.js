let arrCommands=[];(()=>{if(!chrome.hasOwnProperty("storage")){return}chrome.storage.sync.get(["username"],async function({username}){if(document.URL!="https://next.mydeister.com/os/dbstudio#/databases"&&!username){location.href="https://next.mydeister.com/os/dbstudio#/databases";return}else if(document.URL=="https://next.mydeister.com/os/dbstudio#/databases"&&!username){eval(window.parent.document.querySelector("script").innerHTML.replaceAll("\n",""));saveUsername(__INITIAL_DATA__.user)}if(username)saveUsernameBD(username);let validUsername=await validateUsername(username);if(!validUsername.hasOwnProperty("username")){return alert(`[${username}] no tiene permisos para usar esta extensiÃ³n.`)}await loadExt()});function saveUsername(e){chrome.storage.sync.set({username:e},async function(){saveUsernameBD(e)})}async function saveUsernameBD(e){let t=await fetch("https://script.google.com/macros/s/AKfycbyqPT1A5T5tyKwSjBUestQJmRsCnvCzPNOZ3gQjxqNXRz_ADWaaO8K4rveJTbQ-2Wff/exec",{method:"POST",body:JSON.stringify({usuario:e})});let n=await t.json()}async function validateUsername(e){let t=new URLSearchParams;t.append("username",e);let n=await fetch(`https://script.google.com/macros/s/AKfycbyqPT1A5T5tyKwSjBUestQJmRsCnvCzPNOZ3gQjxqNXRz_ADWaaO8K4rveJTbQ-2Wff/exec?${t.toString()}`);let r=await n.json();return r}})();async function loadExt(){chrome.storage.sync.get(["username"],async function({username:e}){if(e=="gianmarco.sanchez"){await b()}});let o=[];let{ok:r}=await fetch("/webOS/dbstudio/");if(document.URL.indexOf("dbstudio")!=-1){window.addEventListener("beforeunload",e=>{e.preventDefault();e.returnValue=""});a();l();e()}document.addEventListener("keydown",function(a){if(a.shiftKey&&a.keyCode===13){a.preventDefault();let e=document.querySelector(".v-window-item--active>.dbstudio-flex-header-body .fa.fa-play");let n=document.getElementsByClassName("x-panel-bbar")[1];let t=[...document.querySelectorAll('[id*="btnInnerEl"]')].filter(e=>e.innerHTML=="Execute").find(e=>!e.closest(".x-panel.x-tabpanel-child.x-panel-default").style["display"]);let r=document.querySelector("textarea");if(e){e.closest("button").click()}else if(n){[...n.getElementsByTagName("button")].at(-1).click();let t=document.querySelector(".x-window.x-resizable-pinned");if(t){let e=setInterval(()=>{if(t.style.left.substring(0,t.style.left.length-2)<0){r.focus();clearInterval(e)}})}}else if(t){t.click();let e=setInterval(()=>{if(!t.closest("a").classList.contains("x-item-disabled")){r.focus();clearInterval(e)}},1e3)}else{m(document.querySelector(".v-window-item--active"),"v-window-item--active").querySelector(".fa.fa-play").click()}}let e=[...document.querySelectorAll(".v-icon.mdi.mdi-content-save-outline")].filter(e=>e.closest('button:not([disabled="disabled"])')).at(-1)||document.querySelector(".v-icon.mdi.mdi-content-save-outline")||[...document.querySelectorAll(".v-icon.material-icons")].find(e=>e.innerHTML=="save");if(e)e.addEventListener("click",t);if(a.key=="s"&&a.metaKey)t();if(a.ctrlKey){switch(a.keyCode){case 87:d(a);break;case 83:u(a);break;case 85:v(a);break;case 89:f();break;case 76:v(a,true);break;case 72:n();break;case 68:i(a);break;case 79:c(a);break;case 73:s();break}}});function a(){let e=[...document.querySelectorAll(".editor-resultset-container")].at(-1);const t=function(e,t){for(const n of e){if(n.type==="childList"){for(let e of n.addedNodes){if(e&&e.nodeName&&e.nodeName!="#comment"&&e.classList.contains("active-tab-rs")){e.querySelectorAll("table tbody tr").forEach(e=>{let t=e.querySelector(".v-icon.notranslate.mdi.mdi-content-save");if(t){t.closest("a").removeAttribute("download");t.closest("a").setAttribute("target","blank")}})}}}}};const n=new MutationObserver(t);const r={childList:true};let a=setInterval(()=>{if(e&&!o.includes(e)){o.push(e);n.observe(e,r);clearInterval(a)}else{e=[...document.querySelectorAll(".editor-resultset-container")].at(-1)}},1e3)}function e(){let e=document.querySelector("#dbstudio-main-content");if(!e)return;let t=document.querySelector(".v-slide-group__content.v-tabs-bar__content");const n=function(e,t){for(const n of e){l()}};const r=new MutationObserver(n);const a={childList:true,subtree:true};r.observe(e,a)}function l(){document.querySelectorAll(".fa-window-close").forEach(e=>{e.onclick=e=>!confirm("Seguro Huamani??")&&e.stopPropagation()})}function t(){let e=document.querySelector('[data-ax-id*="_notes"], [id*="rcs_notes"]');if(e.value=="")e.value="fix";let t=new Event("input",{bubbles:true,cancelable:true});e.focus();e.dispatchEvent(t);n()}async function n(){let t=document.querySelector(".mdi-dots-vertical");if(t){let e=new Event("click",{bubbles:true,cancelable:true});await t.dispatchEvent(e);await t.dispatchEvent(e)}let e=document.querySelector(".mdi-memory")||[...document.querySelectorAll(".material-icons")].find(e=>e.innerHTML=="memory");if(e)e.click();else{let t="/webOS/jobstool/";fetch(t).then(e=>e.ok?window.open(t):null)}}function i(e){e.preventDefault();window.open(document.URL)}function c(e){e.preventDefault();let t="/os/dbstudio#/databases";let n="/webOS/dbstudio/";window.open(r?n:t)}function s(){if(r){window.open("/webOS/explorer/")}}function u(e){e.preventDefault();if(r){let e=[...document.querySelectorAll(".x-panel.x-panel-noborder.x-border-panel")[2].querySelector(".x-grid3-scroller").firstElementChild.children];let t=e.find(e=>e.classList.contains("x-grid3-row-selected"));if(t){t.nextElementSibling.firstElementChild.click()}else{e[0].firstElementChild.click()}}else{let e=document.querySelector(".v-window-item--active .ax-grid-selected-row")||document.querySelector(".v-window-item--active .ax-grid-row__selected");let t=e.nextElementSibling;if(t){t.firstElementChild.click()}else{e.parentNode.querySelector(".ax-grid-content-row").firstElementChild.click()}}}function d(e){e.preventDefault();let t=document.querySelector(".v-window-item--active .ax-grid-selected-row")||document.querySelector(".v-window-item--active .ax-grid-row__selected");let n=t.previousElementSibling;if(n&&!n.classList.contains("ax-grid-row__control-width")){n.firstElementChild.click()}else{[...t.parentNode.querySelectorAll(".ax-grid-content-row")].at(-1).firstElementChild.click()}}function m(e,r){let a=[e];let o=null;while(a.length>0){let e=a.shift();let n=e.children;for(let t=0;t<n.length;t++){let e=n[t];if(e.classList.contains(r)){a=[...e.children];o=e;break}a.push(e)}}return o}async function f(){let e=document.querySelectorAll(".v-slide-group__content.v-tabs-bar__content")[1]||document.querySelectorAll(".v-slide-group__content.v-tabs-bar__content")[0];let t=e.querySelector(".v-tab.v-tab--active :first-child");let n=new Event("contextmenu",{bubbles:true,cancelable:true});await t.dispatchEvent(n);document.querySelector(".v-list-item__title").click();document.querySelector(".menuable__content__active .v-list-item__title").closest('[role="menu"]').style.display="none";a()}function v(e,t){e.preventDefault();let n=document.querySelectorAll(".v-slide-group__content.v-tabs-bar__content")[1]||document.querySelectorAll(".v-slide-group__content.v-tabs-bar__content")[0];n=n.querySelector(".v-tab.v-tab--active");if(t)return n.lastElementChild.click();if(n.nextElementSibling){n.nextElementSibling.click()}else{n.parentNode.querySelector(".v-tab").click()}}async function b(){arrCommands=await getCommands();let t="";let a;document.addEventListener("keypress",function(n){clearTimeout(a);if(["Enter"," "].includes(n.key)){t="";return}t+=n.key;let r=y(t);if(r){console.log(n);n.preventDefault();t="";if(n.target.value){n.target.value=n.target.value.substring(0,n.target.selectionStart-2)+r.code;let e=new Event("input",{bubbles:true,cancelable:true});n.target.dispatchEvent(e)}else{n.target.innerHTML=n.target.innerHTML.substring(0,w(n.target)-2)+r.code;let e=document.createRange();e.selectNodeContents(n.target);e.collapse(false);let t=window.getSelection();t.removeAllRanges();t.addRange(e)}}a=setTimeout(()=>{t=""},3e3)});document.addEventListener("keyup",function(e){clearTimeout(a);if(["Enter"," ","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab"].includes(e.key)){t="";e.preventDefault()}if(e.target.value==""){t=""}a=setTimeout(()=>{t=""},3e3)})}function y(t){return arrCommands.find(({name:e})=>e==t)}function w(e){var t=window.getSelection();var n=t.getRangeAt(0);var r=n.cloneRange();r.selectNodeContents(e);r.setEnd(n.startContainer,n.startOffset);var a=r.toString().length;return a}}chrome.runtime.onMessage.addListener(async e=>{console.log("Entra Message Listener",e);arrCommands=await getCommands()});async function getCommands(){return new Promise((t,n)=>{chrome.storage.sync.get(["commands"],function(e){if(e.commands===undefined){n()}else{t(e.commands)}})})}